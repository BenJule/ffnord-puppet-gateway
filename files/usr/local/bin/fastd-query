#!/bin/bash

SOCKFILE=${SOCKFILE:-/var/run/fastd-status.ffki.sock}
SOCAT=$(which socat 2>/dev/null)
JQ=$(which jq 2>/dev/null)

socketpipe() {
 "$SOCAT" - UNIX:"$SOCKFILE"
}


if [ "x${SOCAT}" = "x" ]; then
  echo "Error: 'socat' not found in PATH"
  exit 2
fi

if [ "x${JQ}" = "x" ]; then
  echo "Error: 'jq' not found in PATH"
  exit 2
fi
case $1 in
  peers|p)
    shift
    QUERY=".peers[]"
    case $1 in
      name|n)
        QUERY="${QUERY} | select(.name == \"${2}\")"
        shift 2
        ;;
      mac|m)
        QUERY="${QUERY} | select( .connection | .mac_addresses[]? == \"${2}\")"
        shift 2
        ;;
      help|h)
        echo "Usage: $0 peers name STRING JQ-STRING"
        echo "       $0 peers mac LLADDR JQ-STRING"
        echo "       $0 peers JQ-STRING"
        exit 0
        ;;
    esac
    socketpipe | jq "$QUERY | ${@:-.}"
    ;;
  connections|c)
    socketpipe | jq '.peers[] | select( .connection ) | .name' | wc -l
    ;;
  statistics|s)
    shift
    socketpipe | jq ".statistics[] | ${@:-.}"
    ;;
  *|help)
    echo "Usage: $0 OBJECT { COMMAND | help }"
    echo "where OBJECT := { STATISTICS | connections | peers }"
    echo "      STATISTICS := statistics JQ-STRING"

  ;;
esac
